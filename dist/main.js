(()=>{"use strict";var t=1920,e=1080,i="diamond";function s(t){return t.reduce(((t,e)=>t+e))}function r(t,e){return JSON.stringify(t)==JSON.stringify(e)}function n(t,e){for(var i=0;i<e.length;i++)if(r(t,e[i]))return!0;return!1}class a{constructor(t,e=[]){this.prefix="[ListManager]:",this.invisible_list=t,this.visible_list=[],this.completed_list=[],this.failed_list=[],this.distractor_list=e}log(t){console.log(`${t}`)}printStatus(){this.log(` >> visible: ${this.visible_list.length}`),this.log(` >> invisible: ${this.invisible_list.length}`),this.log(` >> completed: ${this.completed_list.length}`),this.log(` >> failed: ${this.failed_list.length}`)}printStatusFull(){this.log(` >> visible: ${this.visible_list}`),this.log(` >> invisible: ${this.invisible_list}`),this.log(` >> completed: ${this.completed_list}`),this.log(` >> failed: ${this.failed_list}`)}getRandom(){var t=function(t){if(0!=t.length)return t.splice(Math.floor(Math.random()*t.length),1)[0];console.log("[arrayRemoveRandom]: Empty Array received")}(this.invisible_list);return this.visible_list.push(t),t}remove(t,e=!1,i=!1){return n(t,this.visible_list)?(t=function(t,e){if(0==t.length)console.log("[arrayRemoveRandom]: Empty Array received");else for(var i=0;i<t.length;i++)if(r(t[i],e))return t.splice(i,1),e}(this.visible_list,t),e?i?this.completed_list.push(t):this.failed_list.push(t):this.invisible_list.push(t),!0):(this.log("return: No such items in the visible list"),n(t,this.invisible_list)&&this.log("However, it seems to be in the invisible list. Is it not removed from visible in your code?"),!1)}isDone(){return t=[...this.visible_list,...this.invisible_list],e=this.distractor_list,t.every((t=>e.indexOf(t)>-1));var t,e}}class h{constructor(t,e,i,s){this.image=t,this.rythm=e,this.sound=i,this.input_rythm=[],this.func=s,this.complete=!1,this.error=1}pushBeat(t){this.input_rythm.push(t)}}class o{constructor(t){this.prefix="[Rythm Manager]",this.scope=t,this.currently_hovering=0,this.debug_mode=!1;var e=this;this.rythm_object=[],this.scope.input.keyboard.on("keydown",(function(){0!=e.currently_hovering&&e.click(e.currently_hovering)})),this.scope.input.on("pointerdown",(function(){0!=e.currently_hovering&&e.click(e.currently_hovering)}))}log(t){console.log(`${t}`)}debug(t){this.debug_mode&&console.log(`DEBUG:${t}`)}hoverOver(t){this.debug(`Hovering over ${t}`),this.currently_hovering=t}removeRythmListener(t){r(t,this.currently_hovering.image)&&this.hoverOver(0)}addRythmListener(t,e,i,s=!1,r){var n=new h(t,e,i,r),a=this;n.image.on("pointerover",(function(){a.hoverOver(n)})),n.image.on("pointerout",(function(){a.hoverOver(0)})),s&&a.hoverOver(n)}click(){if(this.curr_time=Date.now(),this.debug(`tap Registered on ${this.currently_hovering}`),0!=this.currently_hovering&&(this.scope.sound.play(this.currently_hovering.sound),this.scope.sound.context.resume()),0==this.currently_hovering.input_rythm.length)this.currently_hovering.input_rythm.push(0);else{var t=this.curr_time-this.start_time;0==this.currently_hovering.input_rythm[0]?this.currently_hovering.input_rythm[0]=t:this.currently_hovering.input_rythm.push(t)}this.start_time=this.curr_time,this.currently_hovering.input_rythm.length==this.currently_hovering.rythm.length&&(this.rythmsMatch(this.currently_hovering)?(this.debug("Rythm Success!"),this.currently_hovering.func(!0,this.currently_hovering),this.currently_hovering=0):(this.debug("Rythm Fail :("),this.currently_hovering.func(!1,this.currently_hovering),this.currently_hovering=0))}rythmsMatch(t){this.log(t.input_rythm),this.log(t.rythm);var e=s(t.input_rythm)/s(t.rythm),i=[];for(let s=0;s<t.rythm.length;s++){var r=t.input_rythm[s],n=t.rythm[s]*e,a=Math.abs(r-n)/n;if(i.push(a),a>.3)return!1}var h=s(i)/i.length;return this.log(`avg. relative error: ${h}`),t.error=h,!0}}class l extends Phaser.Scene{constructor(){super("Study"),this.debug=!1}log(t){console.log(`${t}`)}debug(t){this.debug&&console.log(`DEBUG:${t}`)}init(){this.prev_slide=0,this.slide=1}preload(){this.load.image("white","assets/background_title.jpg")}create(t){this.add.image(960,540,"white").setOrigin(.5),this.main_text=this.add.text(960,540,"Welcome\n\n[Press SPACE to continue]",{fontSize:"40px",fill:"#000",align:"center",fontFamily:"calibri"}),this.main_text.setOrigin(.5),this.debug_text=this.add.text(960,945,"",{fontSize:"35px",fill:"#C00",align:"center",fontFamily:"calibri"}),this.debug_text.setOrigin(.5),this.group_assigned=Math.floor(4*Math.random())+1,this.groups={1:"blue egg now devalued",2:"red egg now devalued",3:"yellow egg keeps valued outcome",4:"cyan egg still no outcome"};var e=this;this.input.keyboard.on("keydown-SPACE",(function(t){e.slide++}))}update(t,e){this.prev_slide!=this.slide&&(this.prev_slide=this.slide,console.log("slide",this.slide),1==this.slide?this.main_text.setText("Welcome\n\nPress SPACE to continue"):2==this.slide?this.main_text.setText("Practise Trial\n\nPress SPACE to continue"):3==this.slide?(this.scene.launch("Training",{successive_correct_required:1,rythm_list:[[2,1,1]]}),this.scene.pause(),this.main_text.setText("Loading Task..."),this.slide++):4==this.slide?this.main_text.setText("Phase 1\n\nPress SPACE to continue"):5==this.slide?(this.scene.launch("Game",{phase_id:1,num_egg_per_color:3,rythm_list:{blueEgg:[1,2,1],redEgg:[1,1,2],yellowEgg:[2,1,1],cyanEgg:[1,100,1]},distractor_list:["cyanEgg"]}),this.scene.pause(),this.main_text.setText("Loading Task..."),this.slide++):6==this.slide?this.main_text.setText("Phase 2\n\nPress SPACE to continue"):7==this.slide?(this.main_text.setText("Phase 2\n\nPress SPACE to continue"),this.debug_text.setText(`Researchers note: You have been assigned to\ngroup ${this.group_assigned} (in phase 2 of the Design spec)\n- ${this.groups[this.group_assigned]} -`)):8==this.slide?(1==this.group_assigned?this.scene.launch("Game",{phase_id:2,num_egg_per_color:3,rythm_list:{blueEgg:[1,100,1],redEgg:[1,1,2],yellowEgg:[2,1,1],cyanEgg:[1,100,1]},distractor_list:["cyanEgg","blueEgg"]}):2==this.group_assigned?this.scene.launch("Game",{phase_id:2,num_egg_per_color:3,rythm_list:{blueEgg:[1,2,1],redEgg:[1,100,2],yellowEgg:[2,1,1],cyanEgg:[1,100,1]},distractor_list:["cyanEgg","redEgg"]}):3==this.group_assigned?this.scene.launch("Game",{phase_id:2,num_egg_per_color:3,rythm_list:{blueEgg:[1,2,1],redEgg:[1,1,2],yellowEgg:[2,1,1],cyanEgg:[1,100,1]},distractor_list:["cyanEgg"]}):4==this.group_assigned?this.scene.launch("Game",{phase_id:2,num_egg_per_color:3,rythm_list:{blueEgg:[1,100,1],redEgg:[1,1,2],yellowEgg:[2,1,1],cyanEgg:[1,100,1]},distractor_list:["cyanEgg","blueEgg"]}):this.main_text.setText("Error, please reload tab"),this.scene.pause(),this.main_text.setText("Loading Task..."),this.debug_text.setText(""),this.slide++):9==this.slide&&(this.main_text.setText("Thank you for participating!\n\nPress SPACE to finish"),function(t,e){for(var i,s=[],r=0;r<e.length;r++)s.push(e[r].join(","));i=t.join(",")+"\r\n"+s.join("\r\n");var n=document.createElement("a"),a=new Blob(["\ufeff",i]),h=URL.createObjectURL(a);n.href=h,n.download="data.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n)}(c,d)))}}class g extends Phaser.Scene{constructor(){super("Training")}log(t){console.log(`${t}`)}debug(t){this.debug_mode&&console.log(`DEBUG:${t}`)}init(t){this.debug_mode=!1,this.prev_round=0,this.round=1,this.rythm_list=[];for(var e=0;e<t.rythm_list.length;e++)for(var i=0;i<t.successive_correct_required;i++)this.rythm_list.push(t.rythm_list[e])}preload(){this.load.image("whitescreen","assets/background_title.jpg"),this.load.image("r_key","assets/r_key.png"),this.load.audio("tap",["assets/chisel.mp3"])}create(t){this.score=0,this.rythm_list_manager=new a(this.rythm_list),this.rythm_manager=new o(this),this.screen_obj=this.add.image(960,540,"whitescreen"),this.screen_obj.setInteractive({useHandCursor:!0}),this.training_text=this.add.text(960,540,"",{fontSize:"50px",fill:"#000  ",align:"center",fontFamily:"calibri"}),this.training_text.setOrigin(.5),this.r_key=this.add.image(960,540,"r_key"),this.r_key.setAlpha(.5)}playRythm(t,e,i,s=500){i.setAlpha(.5);var r=Math.min(...t);t=[0,...t];for(var n=0;n<t.length;n++)t[n]=t[n]/r*300,n>0&&(t[n]+=t[n-1]),this.time.addEvent({delay:s+t[n],callback:function(){this.sound.play(e),this.sound.context.resume(),console.log("tap"),i.setAlpha(1),this.time.addEvent({delay:100,callback:function(){i.setAlpha(.5)},callbackScope:this})},callbackScope:this})}dropTheBeat(){this.debug("Dropping the Beat"),this.training_text.setText(""),this.r_key.setOrigin(.5);var t=this.rythm_list_manager.getRandom();this.playRythm(t,"tap",this.r_key,0),this.time.addEvent({delay:300*s(t)+0+1e3,callback:function(){this.r_key.setAlpha(0);var e=this;this.rythm_manager.addRythmListener(this.screen_obj,t,"tap",!0,(function(i){i?(e.training_text.setText("Correct"),e.r_key.setAlpha(0),e.rythm_list_manager.remove(t,!0,!0)):(e.training_text.setText("Incorrect"),e.r_key.setAlpha(0),e.rythm_list_manager.remove(t)),e.round++})),this.training_text.setText("Please replicate the rythm\nyou have just heard, in any speed you like,\nby tapping any key on the keyboard for every `tap` in that rythm"),this.r_key.setAlpha(.5),this.r_key.setOrigin(.5,-1)},callbackScope:this})}update(t,e){this.rythm_list_manager.isDone()?(this.scene.resume("Study"),this.scene.stop()):this.prev_round!=this.round&&(this.prev_round=this.round,this.time.addEvent({delay:2e3,callback:function(){this.dropTheBeat()},callbackScope:this}))}}var c=["phase","ts","egg","event","input_rythm","actual_rythm","error"],d=[];class u extends Phaser.Scene{constructor(){super("Game")}log(t){console.log(`${t}`)}debug(t){this.debug_mode&&console.log(`DEBUG:${t}`)}init(t){this.debug_mode=!0,this.phase_id=t.phase_id,this.rythm_list=t.rythm_list,this.distractor_list=t.distractor_list,this.eggs_in_game=[...Array.apply(null,Array(t.num_egg_per_color)).map((function(){return"blueEgg"})),...Array.apply(null,Array(t.num_egg_per_color)).map((function(){return"redEgg"})),...Array.apply(null,Array(t.num_egg_per_color)).map((function(){return"yellowEgg"})),...Array.apply(null,Array(t.num_egg_per_color)).map((function(){return"cyanEgg"}))]}preload(){this.load.image("cyanEgg","assets/cyanEgg.png"),this.load.image("blueEgg","assets/blueEgg.png"),this.load.image("redEgg","assets/redEgg.png"),this.load.image("yellowEgg","assets/yellowEgg.png"),this.load.image("diamond","assets/diamond.png"),this.load.image("fail","assets/fail.png"),this.load.image("woods","assets/background.jpg"),this.load.image("safe","assets/safe.png"),this.load.image("white","assets/background_title.jpg"),this.load.audio("tap",["assets/chisel.mp3"]),this.load.audio("diamond",["assets/diamond.mp3"])}generateEggLocations(){for(var t=[],e=1;e+1<8;e++)for(var i=1;i+1<6;i++)t.push({x:Math.floor(240*e+2*(Math.random()-.5)*.2*240),y:Math.floor(180*i+2*(Math.random()-.5)*.2*180)});return t}create(t){this.score=0;this.add.image(960,540,"woods"),this.add.image(960,1020,"safe").setScale(.2).setOrigin(.5),this.scoreText=this.add.text(960,1020,"Depot: 0",{fontSize:"50px",fill:"#FFF",align:"center",fontFamily:"calibri"}),this.scoreText.setOrigin(.5),this.egg_manager=new a(this.eggs_in_game,this.distractor_list),this.location_manager=new a(this.generateEggLocations()),this.rythm_manager=new o(this),this.start_time=Date.now(),this.main_loop=this.time.addEvent({delay:2e3,callback:this.dropEgg,callbackScope:this,loop:!0})}dropEgg(){this.debug("game.dropEgg"),this.debug("-----------------------------------");var t=this,e=this.egg_manager.getRandom(),i=this.location_manager.getRandom(),s=this.add.image(i.x,i.y,e);s.setScale(.2).setInteractive({useHandCursor:!0});var r=this.time.addEvent({delay:5e3,callback:this.removeEgg,args:[s],callbackScope:this});this.rythm_manager.addRythmListener(s,this.rythm_list[e],"tap",!1,(function(e,i){t.removeEgg(s,!0,e,i),r.remove(!1)})),this.debug("-----------------------------------")}removeEgg(t,e=!1,i=!1,s=0){this.debug("game.removeEgg"),this.debug("-----------------------------------"),this.egg_manager.printStatusFull();var r={x:Math.floor(t.x),y:Math.floor(t.y)};this.debug(`Object: ${t.texture.key} at ${r}, complete: ${e}, successful: ${i}`),this.time.addEvent({delay:2500,callback:function(){this.debug("location_manager.remove"),this.location_manager.remove(r)},callbackScope:this}),this.time.addEvent({delay:0,callback:function(){this.debug("egg_manager.remove"),this.egg_manager.remove(t.texture.key,e,i)},callbackScope:this}),this.rythm_manager.removeRythmListener(t),t.setOrigin(0,0),t.destroy();var n=[];e?i?(this.collectEgg(t),n=[this.phase_id,Date.now()-this.start_time,t.texture.key,"collected"]):(this.destroyEgg(t),n=[this.phase_id,Date.now()-this.start_time,t.texture.key,"destroyed"]):n=[this.phase_id,Date.now()-this.start_time,t.texture.key,"returned"],0!=s&&(this.log("Pushing Trial data"),n=[...n,s.input_rythm,s.rythm,s.error]),d.push(n),this.debug("-----------------------------------")}collectEgg(t){this.sound.play(i),this.sound.context.resume(),this.score++,this.scoreText.setText(`Depot: ${this.score}`);var e=this.add.image(t.x,t.y,"diamond");e.setScale(.2),this.time.addEvent({delay:1500,callback:function(){e.destroy()},callbackScope:this})}destroyEgg(t){}update(t,e){this.egg_manager.isDone()&&this.time.addEvent({delay:200,callback:function(){this.scene.resume("Study"),this.scene.stop()},callbackScope:this})}}const m={type:Phaser.AUTO,backgroundColor:"#FFF",scene:[l,g,u],scale:{parent:"viewport",mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,width:t,height:e,min:{width:240,height:135},max:{width:3840,height:2160},zoom:1},autoRound:!1};new Phaser.Game(m)})();